<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medrecall - Pilulier Connecté</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* === PAGE DE CONNEXION === */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }
        
        .login-logo {
            font-size: 4em;
            margin-bottom: 10px;
        }
        
        .login-title {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1.8em;
        }
        
        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1em;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .form-control:focus {
            border-color: #667eea;
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-block {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 10px 0 0 0;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #fd746c 0%, #ff9068 100%);
        }
        
        .login-footer {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .login-footer p {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        /* === DASHBOARD === */
        .dashboard-container {
            display: none;
        }

        .header h1 {
            color: white; /* Changez cette valeur */
            margin-bottom: 10px;
            font-size: 2em;
}

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        .logout-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .status-card .value {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .badge.online {
            background: #d4edda;
            color: #155724;
        }
        
        .badge.offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            color: #333;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            font-size: 1.5em;
        }

        /* === BLOC ÉTAT DU SYSTÈME === */
        .system-status-card {
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .system-status-card.alert {
            border-left-color: #dc3545;
            background: rgba(255, 255, 255, 0.98);
        }
        
        .system-status-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
        }
        
        .system-title {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .system-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .status-pulse {
            position: relative;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status-pulse.operational .status-icon {
            color: #28a745;
            font-size: 18px;
            z-index: 2;
            position: relative;
        }
        
        .status-pulse.alert .status-icon {
            color: #dc3545;
            font-size: 18px;
            z-index: 2;
            position: relative;
            animation: blink 2s infinite;
        }
        
        .pulse-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid;
            animation: pulse 2s infinite;
        }
        
        .status-pulse.operational .pulse-ring {
            border-color: #28a745;
        }
        
        .status-pulse.alert .pulse-ring {
            border-color: #dc3545;
            animation: pulse-alert 1.5s infinite;
        }
        
        .pulse-ring:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .pulse-ring:nth-child(3) {
            animation-delay: 1s;
        }
        
        .status-text {
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .status-pulse.operational + .status-text {
            color: #28a745;
        }
        
        .status-pulse.alert + .status-text {
            color: #dc3545;
            font-weight: bold;
        }

        /* === AUTRES STYLES === */
        .prescription-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .prescription-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .prescription-item:hover {
            background: #e9ecef;
        }
        
        .alert-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            color: #856404;
        }
        
        .alert-item.urgent {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #28a745;
            color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            color: #333;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* === ANIMATIONS === */
        @keyframes pulse {
            0% {
                width: 35px;
                height: 35px;
                opacity: 1;
            }
            100% {
                width: 50px;
                height: 50px;
                opacity: 0;
            }
        }
        
        @keyframes pulse-alert {
            0% {
                width: 35px;
                height: 35px;
                opacity: 1;
                border-color: #dc3545;
            }
            50% {
                border-color: #ff6b7a;
            }
            100% {
                width: 50px;
                height: 50px;
                opacity: 0;
                border-color: #dc3545;
            }
        }
        
        @keyframes blink {
            0%, 50% {
                opacity: 1;
            }
            51%, 100% {
                opacity: 0.3;
            }
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .logout-btn {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- === NOTIFICATION === -->
    <div id="notification" class="notification"></div>

    <!-- === PAGE DE CONNEXION === -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-logo">💊</div>
            <h1 class="login-title">Medrecall</h1>
            <p class="login-subtitle">Pilulier Connecté - Connexion</p>
            
            <div class="error-message" id="errorMessage"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Adresse Email</label>
                    <input type="email" id="email" class="form-control" placeholder="votre@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" class="form-control" placeholder="Votre mot de passe" required>
                </div>
                
                <button type="submit" class="btn btn-block" id="loginBtn">Se connecter</button>
            </form>
            
            <div class="login-footer">
                <p>Accès réservé au personnel médical</p>
            </div>
        </div>
    </div>

    <!-- === DASHBOARD === -->
    <div class="dashboard-container" id="dashboardContainer">
        <button class="logout-btn" onclick="logout()">Déconnexion</button>
        
        <div class="container">
            <div class="header">
                <div class="logo">💊</div>
                <h1>Medrecall - Pilulier Connecté</h1>
                <p>Système de gestion des médicaments intelligent - Temps réel</p>
                <p id="userWelcome" style="margin-top: 10px; font-weight: 600; color: white;"></p>
            </div>
            
            <!-- Barre de statut rapide -->
            <div class="status-bar">
                <div class="status-card">
                    <h3>Heure Actuelle</h3>
                    <div class="value" id="current-time">--:--</div>
                </div>
                <div class="status-card">
                    <h3>Date</h3>
                    <div class="value" id="current-date">--/--/----</div>
                </div>
                <div class="status-card">
                    <h3>Statut WiFi</h3>
                    <div class="value" id="wifi-status">Déconnecté</div>
                    <div class="badge offline" id="wifi-badge">OFFLINE</div>
                </div>
                <div class="status-card">
                    <h3>Alertes Actives</h3>
                    <div class="value" id="active-alerts">0</div>
                </div>
            </div>
            
            <!-- Tableau de bord principal - ORDRE ORIGINAL -->
            <div class="dashboard">
                <!-- Carte Prescriptions -->
                <div class="card">
                    <h2><span class="card-icon">📋</span> Gestion des Prescriptions</h2>
                    <p>Ajouter et gérer les prescriptions médicales en temps réel</p>
                    <button class="btn" onclick="showModal('prescriptions-modal')">Voir les prescriptions</button>
                    <button class="btn" onclick="showModal('add-prescription-modal')">Nouvelle prescription</button>
                    
                    <div id="prescriptions-preview" class="prescription-list" style="margin-top: 15px;">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>
                
                <!-- Carte Alertes -->
                <div class="card">
                    <h2><span class="card-icon">⏰</span> Alertes et Rappels</h2>
                    <p>Surveillance en temps réel des prises de médicaments</p>
                    <button class="btn" onclick="showModal('alerts-modal')">Voir les alertes</button>
                    <button class="btn" onclick="showModal('history-modal')">Historique des prises</button>
                    
                    <div id="alerts-preview" style="margin-top: 15px;">
                        <div class="loading">Chargement des alertes...</div>
                    </div>
                </div>

                <!-- Bloc État du Système -->
                <div class="card system-status-card">
                    <div class="system-status-content">
                        <h4 class="system-title">État du Système</h4>
                        <div class="system-indicator" id="system-indicator">
                            <div class="status-pulse operational" id="status-pulse">
                                <div class="pulse-ring"></div>
                                <div class="pulse-ring"></div>
                                <div class="pulse-ring"></div>
                                <div class="status-icon">✅</div>
                            </div>
                            <span class="status-text" id="status-text">Opérationnel</span>
                        </div>
                    </div>
                </div>
                
                <!-- Carte Paramètres -->
                <div class="card">
                    <h2><span class="card-icon">⚙️</span> Paramètres Système</h2>
                    <p>Configuration du pilulier connecté</p>
                    <button class="btn" onclick="syncTime()">Synchroniser l'heure</button>
                    <button class="btn btn-secondary" onclick="resetSystem()">Reset Système</button>
                    
                    <div style="margin-top: 15px;">
                        <p><strong>IP Device:</strong> <span id="device-ip">--.--.--.--</span></p>
                        <p><strong>Dernière sync:</strong> <span id="last-sync">--:--</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === MODALS === -->
    <div id="prescriptions-modal" class="modal">
        <div class="modal-content">
            <h2>📋 Liste des Prescriptions</h2>
            <div id="prescriptions-list" class="prescription-list">
                <div class="loading">Chargement...</div>
            </div>
            <button class="btn" onclick="showModal('add-prescription-modal')" style="margin-top: 15px;">Ajouter une prescription</button>
            <button class="btn btn-secondary" onclick="hideModal('prescriptions-modal')">Fermer</button>
        </div>
    </div>

    <div id="add-prescription-modal" class="modal">
        <div class="modal-content">
            <h2>➕ Nouvelle Prescription</h2>
            <form id="add-prescription-form">
                <div class="form-group">
                    <label for="prescription-name">Nom de la prescription</label>
                    <input type="text" id="prescription-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="prescription-illness">Maladie/Pathologie</label>
                    <input type="text" id="prescription-illness" class="form-control" required>
                </div>
                <button type="submit" class="btn">Créer la prescription</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('add-prescription-modal')">Annuler</button>
            </form>
        </div>
    </div>

    <!-- === FIREBASE CONFIGURATION === -->
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAFnQUr_gNuffb7MYterSt97OMX9jjekUQ",
            authDomain: "medrecall-5d21e.firebaseapp.com",
            databaseURL: "https://medrecall-5d21e-default-rtdb.firebaseio.com",
            projectId: "medrecall-5d21e",
            storageBucket: "medrecall-5d21e.firebasestorage.app",
            messagingSenderId: "1085038874139",
            appId: "1:1085038874139:web:cf0dfd50bafe84bfec32be",
            measurementId: "G-70RZQQB693"
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Références Firebase
        const prescriptionsRef = database.ref('prescriptions');
        const alertsRef = database.ref('alerts');
        const systemRef = database.ref('system');
        const deviceRef = database.ref('devices/medrecall_01');

        // Variables globales
        let currentPrescriptions = [];
        let currentAlerts = [];
        let systemData = {};
        let lastSystemUpdate = 0;
        const SYSTEM_TIMEOUT = 30000;

        // === GESTION AUTHENTIFICATION ===
        auth.onAuthStateChanged((user) => {
            if (user) {
                showDashboard(user);
            } else {
                showLogin();
            }
        });

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            loginUser();
        });

        function loginUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('errorMessage');

            errorMessage.style.display = 'none';
            loginBtn.textContent = 'Connexion...';
            loginBtn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log('Utilisateur connecté:', user.email);
                })
                .catch((error) => {
                    let errorMsg = 'Erreur de connexion';
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMsg = 'Adresse email invalide';
                            break;
                        case 'auth/user-disabled':
                            errorMsg = 'Compte désactivé';
                            break;
                        case 'auth/user-not-found':
                            errorMsg = 'Utilisateur non trouvé';
                            break;
                        case 'auth/wrong-password':
                            errorMsg = 'Mot de passe incorrect';
                            break;
                        default:
                            errorMsg = error.message;
                    }
                    
                    errorMessage.textContent = errorMsg;
                    errorMessage.style.display = 'block';
                    loginBtn.textContent = 'Se connecter';
                    loginBtn.disabled = false;
                });
        }

        function logout() {
            auth.signOut().then(() => {
                console.log('Utilisateur déconnecté');
            }).catch((error) => {
                console.error('Erreur de déconnexion:', error);
            });
        }

        function showDashboard(user) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            document.getElementById('userWelcome').textContent = `Connecté en tant que: ${user.email}`;
            initFirebaseListeners();
            startClock();
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loginBtn').textContent = 'Se connecter';
            document.getElementById('loginBtn').disabled = false;
        }

        // === GESTION FIREBASE ===
        function initFirebaseListeners() {
            prescriptionsRef.on('value', (snapshot) => {
                currentPrescriptions = snapshot.val() || [];
                updatePrescriptionsDisplay();
                updatePrescriptionsPreview();
            });

            alertsRef.on('value', (snapshot) => {
                currentAlerts = snapshot.val() || [];
                updateAlertsDisplay();
                updateAlertsPreview();
                updateActiveAlertsCount();
            });

            systemRef.on('value', (snapshot) => {
                systemData = snapshot.val() || {};
                updateSystemStatus(systemData);
            });

            deviceRef.on('value', (snapshot) => {
                const deviceData = snapshot.val() || {};
                updateDeviceStatus(deviceData);
            });
        }

        function startClock() {
            function updateClock() {
                const now = new Date();
                document.getElementById('current-time').textContent = 
                    now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('current-date').textContent = 
                    now.toLocaleDateString('fr-FR');
            }
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateSystemStatus(systemData) {
            const currentTime = Date.now();
            lastSystemUpdate = currentTime;
            
            // Mise à jour des informations WiFi
            if (systemData.wifi) {
                document.getElementById('wifi-status').textContent = systemData.wifi.status === 'connected' ? 'Connecté' : 'Déconnecté';
                document.getElementById('wifi-badge').textContent = systemData.wifi.status === 'connected' ? 'ONLINE' : 'OFFLINE';
                document.getElementById('wifi-badge').className = systemData.wifi.status === 'connected' ? 'badge online' : 'badge offline';
                document.getElementById('device-ip').textContent = systemData.wifi.ip || '--.--.--.--';
            }

            if (systemData.lastUpdate) {
                const lastUpdate = new Date(systemData.lastUpdate);
                document.getElementById('last-sync').textContent = lastUpdate.toLocaleTimeString('fr-FR');
            }
            
            checkSystemStatus();
        }

        function updateDeviceStatus(deviceData) {
            // Statut Firebase
            if (deviceData.connected !== undefined) {
                // Mettre à jour l'état du système si nécessaire
            }
        }

        function checkSystemStatus() {
            const currentTime = Date.now();
            const timeSinceLastUpdate = currentTime - lastSystemUpdate;
            const statusPulse = document.getElementById('status-pulse');
            const statusText = document.getElementById('status-text');
            const systemCard = document.querySelector('.system-status-card');
            
            if (timeSinceLastUpdate < SYSTEM_TIMEOUT) {
                statusPulse.className = 'status-pulse operational';
                statusText.textContent = 'Opérationnel';
                statusPulse.innerHTML = `
                    <div class="pulse-ring"></div>
                    <div class="pulse-ring"></div>
                    <div class="pulse-ring"></div>
                    <div class="status-icon">✅</div>
                `;
                systemCard.classList.remove('alert');
            } else {
                statusPulse.className = 'status-pulse alert';
                statusText.textContent = 'Signal Perdu';
                statusPulse.innerHTML = `
                    <div class="pulse-ring"></div>
                    <div class="pulse-ring"></div>
                    <div class="pulse-ring"></div>
                    <div class="status-icon">🚨</div>
                `;
                systemCard.classList.add('alert');
            }
        }

        // === FONCTIONS UTILITAIRES ===
        setInterval(checkSystemStatus, 5000);

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function syncTime() {
            systemRef.child('lastManualSync').set(new Date().toISOString());
            showNotification('Synchronisation horaire demandée!');
        }

        function resetSystem() {
            if (confirm('Êtes-vous sûr de vouloir réinitialiser le système?')) {
                deviceRef.child('resetRequest').set(new Date().toISOString());
                showNotification('Reset demandé!');
            }
        }

        // Gestion des formulaires
        document.getElementById('add-prescription-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('prescription-name').value;
            const illness = document.getElementById('prescription-illness').value;
            
            const newPrescription = {
                nom: name,
                maladie: illness,
                medicaments: [],
                dateCreation: new Date().toISOString()
            };
            
            prescriptionsRef.push(newPrescription);
            showNotification('Prescription ajoutée avec succès!');
            hideModal('add-prescription-modal');
            this.reset();
        });

        // Fonctions à compléter
        function updatePrescriptionsDisplay() {
            const container = document.getElementById('prescriptions-list');
            if (currentPrescriptions.length === 0) {
                container.innerHTML = '<p>Aucune prescription trouvée</p>';
                return;
            }
            container.innerHTML = currentPrescriptions.map((prescription, index) => `
                <div class="prescription-item" onclick="showPrescriptionDetails(${index})">
                    <strong>${prescription.nom || 'Sans nom'}</strong><br>
                    <small>${prescription.maladie || 'Non spécifié'}</small><br>
                    <small>Médicaments: ${prescription.medicaments ? prescription.medicaments.length : 0}</small>
                </div>
            `).join('');
        }

        function updatePrescriptionsPreview() {
            const container = document.getElementById('prescriptions-preview');
            if (currentPrescriptions.length === 0) {
                container.innerHTML = '<p>Aucune prescription</p>';
                return;
            }
            const preview = currentPrescriptions.slice(0, 2);
            container.innerHTML = preview.map(prescription => `
                <div class="prescription-item">
                    <strong>${prescription.nom || 'Sans nom'}</strong><br>
                    <small>${prescription.medicaments ? prescription.medicaments.length : 0} médicament(s)</small>
                </div>
            `).join('');
        }

        function updateAlertsDisplay() {
            const container = document.getElementById('alerts-list');
            const activeAlerts = currentAlerts.filter(alert => alert.active);
            if (activeAlerts.length === 0) {
                container.innerHTML = '<p>Aucune alerte active</p>';
                return;
            }
            container.innerHTML = activeAlerts.map(alert => `
                <div class="alert-item ${alert.urgent ? 'urgent' : ''}">
                    <strong>${alert.medicament}</strong><br>
                    <small>Prescription: ${alert.prescription}</small><br>
                    <small>Heure: ${alert.heure}</small><br>
                    <small>Dose: ${alert.dose}</small>
                </div>
            `).join('');
        }

        function updateAlertsPreview() {
            const container = document.getElementById('alerts-preview');
            const activeAlerts = currentAlerts.filter(alert => alert.active).slice(0, 2);
            if (activeAlerts.length === 0) {
                container.innerHTML = '<p>Aucune alerte</p>';
                return;
            }
            container.innerHTML = activeAlerts.map(alert => `
                <div class="alert-item">
                    <strong>${alert.medicament}</strong><br>
                    <small>À ${alert.heure}</small>
                </div>
            `).join('');
        }

        function updateActiveAlertsCount() {
            const activeCount = currentAlerts.filter(alert => alert.active).length;
            document.getElementById('active-alerts').textContent = activeCount;
        }

        // Fermer les modals en cliquant à l'extérieur
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // Demander la permission pour les notifications
        if ('Notification' in window) {
            Notification.requestPermission();
        }
    </script>
</body>
</html>